# Check results against original GlaDS
#
# The test data was produced with the GlaDS-matlab and the setup of SHMIP-A runs.
#
# Test against state at time 0 (to check ICs match), 5days (to check transient state) and 1000days (almost steady)

"""
    test_against_og(meltinput, time, x, phi, h, atol)

Test the output of a simulation against reference data.

# Arguments
- `meltinput`: Index or key to access specific melt data from `dataOG`.
- `time`: Time at which the comparison is made
- `x`: Array of x-coordinates to be interpolated.
- `phi`: Array of potential values to be compared.
- `h`: Array of thickness values to be compared.
- `atol`: Absolute tolerance for the comparison.
"""
function test_against_og(meltinput, time, x, phi, h, atol)
    d = dataOG[meltinput]
    ti = findfirst(time.>=out_t)
    @assert issorted(x)
    ix = [findfirst(xx.>=x) for xx in out_x] # poor man's interpolation of (x,phi) onto out_x
    @assert all(isapprox.(d[1][ti,:], phi[ix]; atol))
    @assert all(isapprox.(d[2][ti,:], h[ix]; atol))
end

day = 24*3600
out_t = [0.0, 5day, 1000day]
out_x = 1e3* [5    15    25    35    45    55    65    75    85    95]
dataOG = Dict(
   7.9300e-11 => [
          1.0e+07 *
          [ 0.0750    0.0550    0.0000
		    0.2456    0.2270    0.0006
		    0.4093    0.4031    0.0114
		    0.5541    0.5505    0.0563
		    0.6825    0.6776    0.1319
		    0.7978    0.7896    0.2129
		    0.9022    0.8881    0.2851
		    0.9951    0.9722    0.3429
		    1.0715    1.0379    0.3823
		    1.1155    1.0762    0.3993],
         [  0.0500    0.0555    0.0338
		    0.0500    0.0457    0.0036
		    0.0500    0.0459    0.0013
		    0.0500    0.0467    0.0008
		    0.0500    0.0471    0.0006
		    0.0500    0.0470    0.0005
		    0.0500    0.0461    0.0005
		    0.0500    0.0436    0.0004
		    0.0500    0.0375    0.0003
		    0.0500    0.0242    0.0003],
		],
   1.5900e-09 => [
          1.0e+07 *
          [ 0.0761    0.0570    0.0005
		    0.2476    0.2300    0.0831
		    0.4114    0.4059    0.2473
		    0.5563    0.5534    0.3857
		    0.6847    0.6806    0.5038
		    0.8000    0.7925    0.6061
		    0.9043    0.8909    0.6947
		    0.9970    0.9748    0.7692
		    1.0731    1.0404    0.8264
		    1.1167    1.0787    0.8573],
         [  0.0500    0.0557    0.0341
		    0.0500    0.0463    0.0071
		    0.0500    0.0465    0.0068
		    0.0500    0.0473    0.0065
		    0.0500    0.0477    0.0060
		    0.0500    0.0476    0.0054
		    0.0500    0.0467    0.0047
		    0.0500    0.0442    0.0039
		    0.0500    0.0381    0.0030
		    0.0500    0.0247    0.0020],
		],
   5.7900e-09 => [
          1.0e+07 *
          [ 0.0794    0.0625    0.0065
		    0.2532    0.2385    0.1758
		    0.4175    0.4142    0.3450
		    0.5625    0.5619    0.4844
		    0.6911    0.6890    0.6041
		    0.8064    0.8007    0.7088
		    0.9105    0.8986    0.8007
		    1.0026    0.9820    0.8797
		    1.0776    1.0472    0.9431
		    1.1202    1.0854    0.9807],
         [  0.0500    0.0562    0.0367
		    0.0500    0.0480    0.0192
		    0.0500    0.0482    0.0190
		    0.0500    0.0490    0.0181
		    0.0500    0.0494    0.0168
		    0.0500    0.0493    0.0150
		    0.0500    0.0483    0.0130
		    0.0500    0.0458    0.0106
		    0.0500    0.0397    0.0080
		    0.0500    0.0261    0.0051],
		],
   2.5000e-08 => [
          1.0e+07 *
          [ 0.0983    0.0931    0.0580
		    0.2874    0.2869    0.2719
		    0.4562    0.4624    0.4412
		    0.6036    0.6109    0.5802
		    0.7333    0.7380    0.6996
		    0.8482    0.8476    0.8044
		    0.9494    0.9415    0.8971
		    1.0360    1.0197    0.9782
		    1.1032    1.0799    1.0454
		    1.1394    1.1151    1.0888],
         [  0.0500    0.0584    0.0669
		    0.0500    0.0556    0.0617
		    0.0500    0.0560    0.0612
		    0.0500    0.0565    0.0584
		    0.0500    0.0568    0.0540
		    0.0500    0.0565    0.0483
		    0.0500    0.0556    0.0416
		    0.0500    0.0532    0.0337
		    0.0500    0.0474    0.0248
		    0.0500    0.0333    0.0148],
		],
   4.5000e-08 => [
          1.0e+07 *
          [ 0.1476    0.1508    0.1240
		    0.4010    0.4102    0.3445
		    0.6041    0.6149    0.5162
		    0.7666    0.7715    0.6501
		    0.8985    0.8953    0.7588
		    1.0051    0.9951    0.8539
		    1.0868    1.0725    0.9403
		    1.1429    1.1262    1.0177
		    1.1766    1.1586    1.0833
		    1.1917    1.1742    1.1270],
         [  0.0500    0.0597    0.0981
		    0.0500    0.0598    0.0979
		    0.0500    0.0610    0.0982
		    0.0500    0.0623    0.0963
		    0.0500    0.0624    0.0901
		    0.0500    0.0614    0.0800
		    0.0500    0.0601    0.0680
		    0.0500    0.0597    0.0547
		    0.0500    0.0585    0.0399
		    0.0500    0.0485    0.0232],
		],
   5.7900e-07 => [
          1.0e+07 *
          [ 0.4104    0.4225    0.1394
		    0.6678    0.6434    0.3502
		    0.8397    0.8203    0.5427
		    0.9836    0.9664    0.7062
		    1.1103    1.0931    0.8476
		    1.2246    1.2051    0.9684
		    1.3298    1.3037    1.0683
		    1.4276    1.3875    1.1514
		    1.5190    1.4526    1.2211
		    1.5936    1.4903    1.2722],
         [  0.0500    0.2740    0.8193
		    0.0500    0.2711    0.7397
		    0.0500    0.2798    0.7108
		    0.0500    0.2846    0.6745
		    0.0500    0.2868    0.6246
		    0.0500    0.2865    0.5714
		    0.0500    0.2821    0.5053
		    0.0500    0.2690    0.4133
		    0.0500    0.2378    0.2991
		    0.0500    0.1708    0.1486],
		])
